
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>wrapping Unity C# coroutines for exception handling, value retrieval, and locking - tim tregubov</title>
  <meta name="author" content="timofei7">

  
  <meta name="description" content="Firstly, coroutines are awesome. If you aren&#8217;t familiar with them (particularly in the context of Unity3d) then you should be. In short, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://timofei7.github.com/blog/2013/02/05/unity-coroutine-wrapper/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="tim tregubov" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Muli:300,400,300italic,400italic' rel='stylesheet' type='text/css'>
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
<script type="text/javascript" src="http://www.linkedin.com/js/public-profile/widget-os.js"></script>
<link type="text/css" rel="stylesheet" href="/javascripts/galleria/themes/classic/galleria.classic.css">
<script type="text/javascript" src="/javascripts/galleria/galleria.min.js"></script>
<script type="text/javascript" src="/javascripts/galleria/galleria.picasa.min.js"></script>
<script type="text/javascript" src="/javascripts/galleria/themes/classic/galleria.classic.min.js"></script>

<script type="text/javascript">
	 	jQuery.noConflict();
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11362497-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tim tregubov</a></h1>
  
    <h2>tell me a story</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:timofei7.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/blog/categories/portfolio">Portfolio</a></li>
  <li><a href="/blog/categories/writing">Writing</a></li>
  <li><a href="/blog/categories/codes">Codes</a></li>
  <li><a href="/blog/categories/log">Log</a></li>
  <li><a href="/resume/">Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Wrapping Unity C# Coroutines for Exception Handling, Value Retrieval, and Locking</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-05T01:40:00-08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Firstly, coroutines are awesome.  If you aren&#8217;t familiar with them (particularly in the context of Unity3d) then you should be.  In short, <a href="http://en.wikipedia.org/wiki/Coroutine">coroutines</a> are methods that can suspend and resume execution.  In the context of Unity what this means is that you can have methods that appear to run concurrently. The Unity documentation has some <a href="http://docs.unity3d.com/Documentation/ScriptReference/index.Coroutines_26_Yield.html">examples</a>.</p>

<p>Coroutines are <strong>the</strong> way to script a lot of things in Unity, however there are a few problems that you may run into if you use them heavily: exception handling, return values, and locking. Especially if you use nested coroutines!</p>

<!--more-->


<h3>Return Values</h3>

<p>Coroutines in Unity, although built on iterators, don&#8217;t handle return values. Even though it appears as if you can return a value, internally return values are used to keep track of where to resume.  But, &#8220;I want a coroutine to return something!&#8221;, you say.  So you work around that using a callback:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">IEnumerator</span> <span class="nf">FooBar</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">DoSomethingEverySecond</span><span class="p">(</span><span class="n">success</span><span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
</span><span class='line'>          <span class="n">doMoreStuff</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">IEnumerator</span> <span class="nf">DoSomethingEverySecond</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Action</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">success</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">result</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>  <span class="k">foreach</span> <span class="p">(</span><span class="n">Something</span> <span class="n">s</span> <span class="k">in</span> <span class="n">somethings</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">doStuff</span><span class="p">())</span>
</span><span class='line'>          <span class="n">result</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>      <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">1f</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">success</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">success</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok so this helps with getting a return value out of a coroutine.  It works well enough. Only caveat is in the callback code you can&#8217;t do another yield, not a big problem, and solveable by setting some variables. We&#8217;ll return to this topic.</p>

<h3>Exception Handling</h3>

<p>There is no exception handling at the coroutine level.  You can&#8217;t put a <code>yield</code> statement in a <code>try…catch</code> block.  This in particular can cause a problem if you have nested coroutines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="p">{</span> <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">ParentCoroutine</span><span class="p">());</span> <span class="p">}</span> <span class="c1">//can try...catch if there&#39;s no yielding</span>
</span><span class='line'>  <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">&quot;oh noes we had a problem: &quot;</span> <span class="p">+</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">IEnumerator</span> <span class="nf">ParentCoroutine</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">NestedCoroutineDoSomeStuff</span><span class="p">());</span>  <span class="c1">//can&#39;t try...catch these</span>
</span><span class='line'>  <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">NestedCoroutineFoo</span><span class="p">());</span> <span class="c1">//if this has an exception nothing below executes</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
</span><span class='line'>      <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">NestedCoroutineBar</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Logically, if any of the nested coroutines throw an exception then the parent will stop execution.  Now, this is only fair, but since you can&#8217;t <code>try…catch</code> the nested coroutines it forces you to have to do error handling at a much more obnoxious nested level.  You have to make sure to handle all exceptions in each subroutine, even if it doesn&#8217;t really make sense to do that.  For instance you have a MovePiece coroutine,  if it fails (say the piece was attacked mid move) what you&#8217;d like to do in the parent coroutine (which is something like AttackState) is notice the failed move and handle it there.  If the MovePiece coroutine does a bunch of stuff (set some flags, run a few different animations) the parent probably only cares whether it was successfull or not.  You could use a callback like above to indicate success but, this doesn&#8217;t help if MovePiece threw an exception.  In that case the parent coroutine exits and we&#8217;re stuck handling the exception at too high a level (say in a non-coroutine above the parent). Not ideal.</p>

<p>Ideally we&#8217;d be able to catch any exception per coroutine (nested or not) allowing us to think of each coroutine as a logical unit as it should be.  A great solution for this <a href="http://twistedoakstudios.com/blog/Post83_coroutines-more-than-you-want-to-know">exists</a>. Part of this solution is also a better way to handle return values without having to use a callback.  This uses a parametrized wrapper to Coroutine and allows us to handle exceptions and return values like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">Coroutine</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">dostuff</span> <span class="p">=</span> <span class="n">StartCoroutine</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;(</span><span class="n">DoStuff</span><span class="p">());</span> <span class="c1">// declare a return value type</span>
</span><span class='line'><span class="k">yield</span> <span class="k">return</span> <span class="n">dostuff</span><span class="p">.</span><span class="n">coroutine</span><span class="p">;</span>
</span><span class='line'><span class="k">try</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dostuff</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>  <span class="c1">//attempt to access the return value</span>
</span><span class='line'>      <span class="n">NextStuff</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">catch</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//and handle any exceptions here</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>That is much better!  Now the child exits without interrupting the parent and the parent can deal with it appropriately (exceptions and return values).  Now, what&#8217;s this about locking?</p>

<h3>Locking</h3>

<p>The other problem is locking.  Coroutines (although technically not multi-threaded in Unity) do cause concurrency problems!  What if, based on user input, you start a Coroutine multiple times and it operates on the same objects?  A mess can ensue.  One solution in Unity is that you can start a coroutine using a string name of the IEnumerator method.  This uses reflection and is yucky.  Who want to use strings when you&#8217;re using a nice strongly typed language like C#?  But, if you use strings you can do <code>StopCoroutine("DoStuff"); StartCoroutine("DoStuff")</code>.  Another option is to just have some instance variable bool and appropriate logic for every coroutine.  This too gets messy quickly with lots of coroutines.</p>

<p>These techniques get you part of the way but what if you want a coroutine to actually just block/wait for a previous instance to finish running like traditional locking but without any undue messiness?  Well using <code>lock(someobject)</code> doesn&#8217;t work, because it would only be evaluated once and isn&#8217;t checked on the coroutine resume.  Some people have written large coroutine managers that help with all these problems but those seemed like overkill so I built on the exception handling stuff and added locking support. The idea is that you start the coroutine with a string identifier (if none is given no locking is performed) and an optional timeout period.  With the string identifier each MonoBehavior keeps the currently running coroutines in a queue and either yields (analogous to blocking on a lock) until it&#8217;s turn comes up or bails on a timeout.  Like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">StartCoroutine</span><span class="p">(</span><span class="n">DoStuff</span><span class="p">(),</span> <span class="s">&quot;DoStuff&quot;</span><span class="p">,</span> <span class="m">10f</span><span class="p">);</span> <span class="c1">// will yield null</span>
</span><span class='line'>                                           <span class="c1">// if any previous &quot;DoStuff&quot;s are running up to 10seconds</span>
</span></code></pre></td></tr></table></div></figure>


<p>The easiest way to use this is to extend MonoBehaviour and use the new class as the base class for all your MonoBehaviours.  Here is mine:</p>

<figure class='code'><figcaption><span>My MonoBehaviour Base Class   (TTMonoBehaviour.cs)</span> <a href='/downloads/code/csharp/TTMonoBehaviour.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'><span class="c1">/// Extending MonoBehaviour to add some extra functionality</span>
</span><span class='line'><span class="c1">/// Exception handling from: http://twistedoakstudios.com/blog/Post83_coroutines-more-than-you-want-to-know</span>
</span><span class='line'><span class="c1">/// </span>
</span><span class='line'><span class="c1">/// 2013 Tim Tregubov</span>
</span><span class='line'><span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TTMonoBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">LockQueue</span> <span class="n">LockedCoroutineQueue</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          
</span><span class='line'>  <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>  <span class="c1">/// Coroutine with return value AND exception handling on the return value. </span>
</span><span class='line'>  <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">StartCoroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">coroutineObj</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">coroutineObj</span><span class="p">.</span><span class="n">coroutine</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">StartCoroutine</span><span class="p">(</span><span class="n">coroutineObj</span><span class="p">.</span><span class="n">InternalRoutine</span><span class="p">(</span><span class="n">coroutine</span><span class="p">));</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">coroutineObj</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>  <span class="c1">/// Lockable coroutine. Can either wait for a previous coroutine to finish or a timeout or just bail if previous one isn&#39;t done.</span>
</span><span class='line'>  <span class="c1">/// Caution: the default timeout is 10 seconds. Coroutines that timeout just drop so if its essential increase this timeout.</span>
</span><span class='line'>  <span class="c1">/// Set waitTime to 0 for no wait</span>
</span><span class='line'>  <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">StartCoroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lockID</span><span class="p">,</span> <span class="kt">float</span> <span class="n">waitTime</span> <span class="p">=</span> <span class="m">10f</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">LockedCoroutineQueue</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="n">LockedCoroutineQueue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LockQueue</span><span class="p">();</span>
</span><span class='line'>      <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">coroutineObj</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">waitTime</span><span class="p">,</span> <span class="n">LockedCoroutineQueue</span><span class="p">);</span>
</span><span class='line'>      <span class="n">coroutineObj</span><span class="p">.</span><span class="n">coroutine</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">StartCoroutine</span><span class="p">(</span><span class="n">coroutineObj</span><span class="p">.</span><span class="n">InternalRoutine</span><span class="p">(</span><span class="n">coroutine</span><span class="p">));</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">coroutineObj</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>  <span class="c1">/// Coroutine with return value AND exception handling AND lockable</span>
</span><span class='line'>  <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Coroutine</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">private</span> <span class="n">T</span> <span class="n">returnVal</span><span class="p">;</span>
</span><span class='line'>      <span class="k">private</span> <span class="n">Exception</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>      <span class="k">private</span> <span class="kt">string</span> <span class="n">lockID</span><span class="p">;</span>
</span><span class='line'>      <span class="k">private</span> <span class="kt">float</span> <span class="n">waitTime</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">private</span> <span class="n">LockQueue</span> <span class="n">lockedCoroutines</span><span class="p">;</span> <span class="c1">//reference to objects lockdict</span>
</span><span class='line'>      <span class="k">private</span> <span class="kt">bool</span> <span class="n">lockable</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">public</span> <span class="n">Coroutine</span> <span class="n">coroutine</span><span class="p">;</span>
</span><span class='line'>      <span class="k">public</span> <span class="n">T</span> <span class="n">Value</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">get</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">throw</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">returnVal</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">public</span> <span class="nf">Coroutine</span><span class="p">()</span> <span class="p">{</span> <span class="n">lockable</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">Coroutine</span><span class="p">(</span><span class="kt">string</span> <span class="n">lockID</span><span class="p">,</span> <span class="kt">float</span> <span class="n">waitTime</span><span class="p">,</span> <span class="n">LockQueue</span> <span class="n">lockedCoroutines</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">lockable</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">lockID</span> <span class="p">=</span> <span class="n">lockID</span><span class="p">;</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">lockedCoroutines</span> <span class="p">=</span> <span class="n">lockedCoroutines</span><span class="p">;</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">waitTime</span> <span class="p">=</span> <span class="n">waitTime</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">public</span> <span class="n">IEnumerator</span> <span class="nf">InternalRoutine</span><span class="p">(</span><span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">lockable</span> <span class="p">&amp;&amp;</span> <span class="n">lockedCoroutines</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>        
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">lockID</span><span class="p">))</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">waitTime</span> <span class="p">==</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="c1">//Debug.Log(this.GetType().Name + &quot;: coroutine already running and wait not requested so exiting: &quot; + lockID);</span>
</span><span class='line'>                      <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">else</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="c1">//Debug.Log(this.GetType().Name + &quot;: previous coroutine already running waiting max &quot; + waitTime + &quot; for my turn: &quot; + lockID);</span>
</span><span class='line'>                      <span class="kt">float</span> <span class="n">starttime</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
</span><span class='line'>                      <span class="kt">float</span> <span class="n">counter</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">while</span> <span class="p">(!</span><span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">First</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="p">-</span> <span class="n">starttime</span><span class="p">)</span> <span class="p">&lt;</span> <span class="n">waitTime</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">{</span>
</span><span class='line'>                          <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>                          <span class="n">counter</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
</span><span class='line'>                      <span class="p">}</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="p">&gt;=</span> <span class="n">waitTime</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">{</span>
</span><span class='line'>                          <span class="kt">string</span> <span class="n">error</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;: coroutine &quot;</span> <span class="p">+</span> <span class="n">lockID</span> <span class="p">+</span> <span class="s">&quot; bailing! due to timeout: &quot;</span> <span class="p">+</span> <span class="n">counter</span><span class="p">;</span>
</span><span class='line'>                          <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>                          <span class="k">this</span><span class="p">.</span><span class="n">e</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>                          <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>                          <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                      <span class="p">}</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          
</span><span class='line'>          <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">try</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(!</span><span class="n">coroutine</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(</span><span class="n">lockable</span><span class="p">)</span> <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">this</span><span class="p">.</span><span class="n">e</span> <span class="p">=</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">Debug</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot;: caught Coroutine exception! &quot;</span> <span class="p">+</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span> <span class="p">+</span> <span class="s">&quot;\n&quot;</span> <span class="p">+</span> <span class="n">e</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">lockable</span><span class="p">)</span> <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              
</span><span class='line'>              <span class="kt">object</span> <span class="n">yielded</span> <span class="p">=</span> <span class="n">coroutine</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">yielded</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">yielded</span><span class="p">.</span><span class="n">GetType</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">returnVal</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">yielded</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">lockable</span><span class="p">)</span> <span class="n">lockedCoroutines</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">yield</span> <span class="k">return</span> <span class="n">coroutine</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>  <span class="c1">/// coroutine lock and queue</span>
</span><span class='line'>  <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">LockQueue</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;&gt;</span> <span class="n">LockedCoroutines</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">public</span> <span class="nf">LockQueue</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">LockedCoroutines</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>      <span class="c1">/// check if LockID is locked</span>
</span><span class='line'>      <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Contains</span><span class="p">(</span><span class="kt">string</span> <span class="n">lockID</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">LockedCoroutines</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">lockID</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>      <span class="c1">/// check if given coroutine is first in the queue</span>
</span><span class='line'>      <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">bool</span> <span class="nf">First</span><span class="p">(</span><span class="kt">string</span> <span class="n">lockID</span><span class="p">,</span> <span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">bool</span> <span class="n">ret</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">Contains</span><span class="p">(</span><span class="n">lockID</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">ret</span> <span class="p">=</span> <span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="n">coroutine</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>      <span class="c1">/// Add the specified lockID and coroutine to the coroutine lockqueue</span>
</span><span class='line'>      <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">string</span> <span class="n">lockID</span><span class="p">,</span> <span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(!</span><span class="n">LockedCoroutines</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">lockID</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">LockedCoroutines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lockID</span><span class="p">,</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;());</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          
</span><span class='line'>          <span class="k">if</span> <span class="p">(!</span><span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Contains</span><span class="p">(</span><span class="n">coroutine</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Add</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'>      <span class="c1">/// Remove the specified coroutine and queue if empty</span>
</span><span class='line'>      <span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Remove</span><span class="p">(</span><span class="kt">string</span> <span class="n">lockID</span><span class="p">,</span> <span class="n">IEnumerator</span> <span class="n">coroutine</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">bool</span> <span class="n">ret</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">LockedCoroutines</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">lockID</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Contains</span><span class="p">(</span><span class="n">coroutine</span><span class="p">))</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">ret</span> <span class="p">=</span> <span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Remove</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">LockedCoroutines</span><span class="p">[</span><span class="n">lockID</span><span class="p">].</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">ret</span> <span class="p">=</span> <span class="n">LockedCoroutines</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">lockID</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What do you think?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">timofei7</span></span>

      








  


<time datetime="2013-02-05T01:40:00-08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/codes/'>Codes</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://timofei7.github.com/blog/2013/02/05/unity-coroutine-wrapper/" data-via="timofei7" data-counturl="http://timofei7.github.com/blog/2013/02/05/unity-coroutine-wrapper/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/11/unity-prefab-singleton/" title="Previous Post: generic singleton MonoBehavior part 2: singleton self loading prefab">&laquo; generic singleton MonoBehavior part 2: singleton self loading prefab</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/02/14/chessinvaders-update/" title="Next Post: chessInvaders update">chessInvaders update &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>Elsewhere</h1>

<div class="profile">
 <ul>
	 <li id="linkedin">
	 <a href="http://www.linkedin.com/in/timtregubov" target="_blank">linkedin profile</a>
	 </li>
	 <li id="facebook">
	 <a href="http://www.facebook.com/tim.tregubov" target="_blank">facebook profile</a>
	 </li>
	 <li id="youtube">
	 <a href="http://www.youtube.com/user/timofei7" target="_blank">youtube channel</a>
	 </li>
 </ul>
 </div>

</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("timofei7", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/timofei7" class="twitter-follow-button" data-show-count="false">Follow @timofei7</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/timofei7">@timofei7</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'timofei7',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/02/14/chessinvaders-update/">chessInvaders update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/05/unity-coroutine-wrapper/">wrapping Unity C# coroutines for exception handling, value retrieval, and locking</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/11/unity-prefab-singleton/">generic singleton MonoBehavior part 2: singleton self loading prefab</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/25/chessinvaders-update/">chessInvaders update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/26/unity-singletons/">generic singleton MonoBehavior class</a>
      </li>
    
  </ul>
</section>


<section class="tag-cloud">
    <h1>Tags</h1>
    <a style='font-size: 1.41em' href='//iOS'>iOS</a>
<a style='font-size: 1.41em' href='//chess'>chess</a>
<a style='font-size: 1.19em' href='//brain'>brain</a>
<a style='font-size: 0.80em' href='//geometry'>geometry</a>
<a style='font-size: 1.80em' href='//education'>education</a>
<a style='font-size: 0.80em' href='//energy'>energy</a>
<a style='font-size: 0.80em' href='//lift'>lift</a>
<a style='font-size: 0.80em' href='//polarbear'>polarbear</a>
<a style='font-size: 0.80em' href='//carving'>carving</a>
<a style='font-size: 0.80em' href='//scala'>scala</a>
<a style='font-size: 0.80em' href='//startup'>startup</a>
<a style='font-size: 1.57em' href='//game'>game</a>
<a style='font-size: 1.19em' href='//animation'>animation</a>
<a style='font-size: 1.19em' href='//happiness'>happiness</a>
<a style='font-size: 0.80em' href='//digital-arts'>digital arts</a>
<a style='font-size: 0.80em' href='//games'>games</a>
<a style='font-size: 0.80em' href='//grad-school'>grad school</a>
<a style='font-size: 0.80em' href='//coroutine'>coroutine</a>
<a style='font-size: 1.57em' href='//3D'>3D</a>
<a style='font-size: 0.80em' href='//life'>life</a>
<a style='font-size: 0.80em' href='//future'>future</a>
<a style='font-size: 1.41em' href='//unity3d'>unity3d</a>
<a style='font-size: 0.80em' href='//kinect'>kinect</a>
<a style='font-size: 0.80em' href='//openCV'>openCV</a>
<a style='font-size: 1.19em' href='//modeling'>modeling</a>
<a style='font-size: 0.80em' href='//randomness'>randomness</a>
<a style='font-size: 1.19em' href='//singleton'>singleton</a>
<a style='font-size: 0.80em' href='//van'>van</a>
<a style='font-size: 1.41em' href='//c-'>c#</a>
<a style='font-size: 0.80em' href='//fear'>fear</a>
<a style='font-size: 0.80em' href='//geopolitics'>geopolitics</a>
<a style='font-size: 0.80em' href='//drawing'>drawing</a>
<a style='font-size: 1.19em' href='//engineering'>engineering</a>
<a style='font-size: 0.80em' href='//openNI'>openNI</a>
 
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - timofei7 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'timtregubov';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://timofei7.github.com/blog/2013/02/05/unity-coroutine-wrapper/';
        var disqus_url = 'http://timofei7.github.com/blog/2013/02/05/unity-coroutine-wrapper/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
